name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # PHASE 1: Fast checks (parallel)
  # ============================================

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - run: cargo fmt --check --package techno_sutra

  check-linux:
    name: Check Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install deps
        run: |
          sudo apt-get update && sudo apt-get install -y \
            g++ pkg-config libx11-dev libwayland-dev libasound2-dev libudev-dev
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-desktop
          cache-all-crates: true
          cache-on-failure: true
          cache-targets: true
      - run: cargo check --release --features desktop

  check-windows:
    name: Check Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: windows-desktop
          cache-all-crates: true
          cache-on-failure: true
          cache-targets: true
      - run: cargo check --release --features desktop

  check-wasm:
    name: Check WASM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: wasm-webxr
          cache-all-crates: true
          cache-on-failure: true
          cache-targets: true
      - run: rustup target add wasm32-unknown-unknown
      - run: cargo check --release --target wasm32-unknown-unknown --features webxr --no-default-features

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install deps
        run: |
          sudo apt-get update && sudo apt-get install -y \
            g++ pkg-config libx11-dev libwayland-dev libasound2-dev libudev-dev
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: linux-desktop
          cache-all-crates: true
          cache-on-failure: true
          cache-targets: true
      - run: cargo clippy --release --features desktop -- -D warnings

  check-ios:
    name: Check iOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - run: rustup target add aarch64-apple-ios
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ios-arm64
          cache-all-crates: true
          cache-on-failure: true
          cache-targets: true
      - name: Check iOS
        run: |
          cargo check --release --target aarch64-apple-ios --no-default-features \
            --features "bevy/bevy_asset,bevy/bevy_core_pipeline,bevy/bevy_pbr,bevy/bevy_render,bevy/bevy_winit,bevy/png,bevy/jpeg"

  check-android:
    name: Check Android
    runs-on: ubuntu-latest
    env:
      NDK_VERSION: '25.2.9519653'
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: android-actions/setup-android@v3
      - name: Install NDK
        run: |
          sdkmanager --install "ndk;${{ env.NDK_VERSION }}"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
      - run: rustup target add aarch64-linux-android
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: android-arm64
          cache-all-crates: true
          cache-on-failure: true
          cache-targets: true
      - name: Check Android
        run: |
          export PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          cargo check --release --target aarch64-linux-android --no-default-features \
            --features "bevy/bevy_asset,bevy/bevy_core_pipeline,bevy/bevy_pbr,bevy/bevy_render,bevy/bevy_winit,bevy/android-game-activity,bevy/png,bevy/jpeg"

  # ============================================
  # PHASE 2: Builds (after checks pass)
  # ============================================

  build-linux:
    name: ðŸ§ Linux
    needs: [fmt, check-linux, clippy]
    uses: ./.github/workflows/_build-linux.yml
    with:
      features: desktop
      artifact_prefix: techno-sutra
      retention_days: 7

  build-windows:
    name: ðŸªŸ Windows
    needs: [fmt, check-windows]
    uses: ./.github/workflows/_build-windows.yml
    with:
      features: desktop
      artifact_prefix: techno-sutra
      retention_days: 7

  build-macos:
    name: ðŸŽ macOS
    needs: [fmt, clippy]
    uses: ./.github/workflows/_build-macos.yml
    with:
      features: desktop
      artifact_prefix: techno-sutra
      retention_days: 7

  build-wasm:
    name: ðŸŒ WASM
    needs: [fmt, check-wasm]
    uses: ./.github/workflows/_build-wasm.yml
    with:
      optimize: true
      artifact_name: techno-sutra-web
      public_url: /Vortex-R3D/
      features: webxr
      retention_days: 7

  build-ios:
    name: ðŸ“± iOS
    needs: [fmt, check-ios]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/_build-ios.yml
    with:
      artifact_prefix: techno-sutra
      retention_days: 7

  build-android:
    name: ðŸ¤– Android
    needs: [fmt, check-android]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/_build-android.yml
    with:
      artifact_prefix: techno-sutra
      retention_days: 7
      build_quest: false

  # ============================================
  # PHASE 3: Deploy (after WASM build on main)
  # ============================================

  deploy-pages:
    name: ðŸš€ Deploy Pages
    needs: [build-wasm]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: techno-sutra-web
          path: dist

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ============================================
  # PHASE 4: Create Release (after all builds on main)
  # ============================================

  create-release:
    name: ðŸ“¦ Create Release
    needs: [build-linux, build-windows, build-macos, build-wasm]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && always() && !failure() && !cancelled()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize release files
        run: |
          mkdir -p release
          
          # Linux
          cp artifacts/techno-sutra-linux-tarball/*.tar.gz release/ 2>/dev/null || true
          cp artifacts/techno-sutra-linux-deb/*.deb release/ 2>/dev/null || true
          cp artifacts/techno-sutra-linux-appimage/*.AppImage release/ 2>/dev/null || true
          
          # Windows
          cp artifacts/techno-sutra-windows-zip/*.zip release/ 2>/dev/null || true
          
          # macOS
          cp artifacts/techno-sutra-macos-zip/*.zip release/ 2>/dev/null || true
          
          # iOS
          cp artifacts/techno-sutra-ios-ipa/*.ipa release/ 2>/dev/null || true
          
          # Android
          cp artifacts/techno-sutra-android-apk/*.apk release/ 2>/dev/null || true
          
          # Web (zip the dist)
          cd artifacts/techno-sutra-web && zip -r ../../release/techno-sutra-web-${{ steps.version.outputs.version }}.zip . && cd ../..
          
          ls -la release/

      - name: Generate release notes
        id: notes
        run: |
          cat > release_notes.md << 'EOF'
          # Techno Sutra ${{ steps.version.outputs.tag }}
          
          ðŸ•‰ï¸ **Immersive Panorama Viewer** - Cross-platform 360Â° experience
          
          ## ðŸŒ Live Demo
          
          **[Launch Web App](https://${{ github.repository_owner }}.github.io/Vortex-R3D/)**
          
          ## ðŸ“¥ Downloads
          
          | Platform | Download | Notes |
          |----------|----------|-------|
          | ðŸŒ **Web** | [techno-sutra-web.zip](../../releases/download/${{ steps.version.outputs.tag }}/techno-sutra-web-${{ steps.version.outputs.version }}.zip) | Host anywhere, runs in browser |
          | ðŸ§ **Linux** | [.tar.gz](../../releases/download/${{ steps.version.outputs.tag }}/techno-sutra-linux-x64-v${{ steps.version.outputs.version }}.tar.gz) / [.deb](../../releases/download/${{ steps.version.outputs.tag }}/techno-sutra_${{ steps.version.outputs.version }}_amd64.deb) / [.AppImage](../../releases/download/${{ steps.version.outputs.tag }}/techno-sutra-linux-x64-v${{ steps.version.outputs.version }}.AppImage) | x64 |
          | ðŸªŸ **Windows** | [.zip](../../releases/download/${{ steps.version.outputs.tag }}/techno-sutra-windows-x64-v${{ steps.version.outputs.version }}.zip) | x64, portable |
          | ðŸŽ **macOS** | [.zip](../../releases/download/${{ steps.version.outputs.tag }}/techno-sutra-macos-universal-v${{ steps.version.outputs.version }}.zip) | Universal (Intel + Apple Silicon) |
          | ðŸ“± **iOS** | [.ipa](../../releases/download/${{ steps.version.outputs.tag }}/techno-sutra-ios-v${{ steps.version.outputs.version }}.ipa) | Requires sideloading |
          | ðŸ¤– **Android** | [.apk](../../releases/download/${{ steps.version.outputs.tag }}/techno-sutra-android-v${{ steps.version.outputs.version }}.apk) | ARM64 |
          
          ## ðŸŽ® Controls
          
          | Input | Action |
          |-------|--------|
          | **Click/Tap** | Capture input |
          | **Mouse/Touch** | Look around |
          | **WASD** | Look around (desktop) |
          | **+/-** | Adjust FOV |
          | **Pinch** | Zoom (mobile) |
          | **Esc** | Release mouse |
          
          ## âœ¨ Features
          
          - ðŸŒ Equirectangular to cubemap conversion (GPU)
          - ðŸŽ® First-person panorama navigation
          - ðŸ”Š Spatial 3D audio
          - ðŸ¥½ WebXR VR support
          - ðŸ“± Touch controls for mobile
          - ðŸ–¥ï¸ Cross-platform (Desktop, Web, Mobile)
          
          ---
          
          **Built with [Bevy](https://bevyengine.org/) ðŸ¦€**
          EOF
          
          # Add recent commits
          echo "" >> release_notes.md
          echo "## ðŸ“ Changes" >> release_notes.md
          echo "" >> release_notes.md
          git log --oneline -10 --pretty=format:"- %s" >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Techno Sutra ${{ steps.version.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: release/*
          generate_release_notes: false
          make_latest: true
