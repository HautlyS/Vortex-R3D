name: Build WASM (Reusable)

on:
  workflow_call:
    inputs:
      public_url:
        description: 'Base URL path for assets (e.g., /repo-name/ for GitHub Pages)'
        required: false
        type: string
        default: '/'
      optimize:
        description: 'Run wasm-opt optimization'
        required: false
        type: boolean
        default: true
      artifact_name:
        description: 'Name for the uploaded artifact'
        required: false
        type: string
        default: 'wasm-dist'
      retention_days:
        description: 'Artifact retention days'
        required: false
        type: number
        default: 7
      features:
        description: 'Cargo features to enable'
        required: false
        type: string
        default: 'webxr'
    outputs:
      artifact_name:
        description: 'Name of the uploaded artifact'
        value: ${{ jobs.build.outputs.artifact_name }}

env:
  CARGO_TERM_COLOR: always
  TRUNK_VERSION: '0.21.14'

jobs:
  build:
    name: Build WASM
    runs-on: ubuntu-latest
    outputs:
      artifact_name: ${{ inputs.artifact_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: wasm-webxr
          cache-all-crates: true
          cache-on-failure: true
          cache-targets: true
          workspaces: ". -> target"

      - name: Cache Trunk tools
        uses: actions/cache@v4
        with:
          path: ~/.cache/trunk
          key: trunk-tools-${{ runner.os }}

      - name: Install Trunk (pre-built binary)
        run: |
          TRUNK_BIN="$HOME/.cargo/bin/trunk"
          if [ -f "$TRUNK_BIN" ] && "$TRUNK_BIN" --version 2>/dev/null | grep -q "${{ env.TRUNK_VERSION }}"; then
            echo "âœ… Trunk ${{ env.TRUNK_VERSION }} already installed"
          else
            echo "ðŸ“¦ Downloading Trunk ${{ env.TRUNK_VERSION }}..."
            curl -sL https://github.com/trunk-rs/trunk/releases/download/v${{ env.TRUNK_VERSION }}/trunk-x86_64-unknown-linux-gnu.tar.gz | tar xz -C /tmp
            mkdir -p ~/.cargo/bin
            mv /tmp/trunk ~/.cargo/bin/
            echo "âœ… Trunk installed"
          fi
          trunk --version

      - name: Configure features in index.html
        if: ${{ inputs.features != 'webxr' }}
        run: |
          sed -i 's/data-cargo-features="[^"]*"/data-cargo-features="${{ inputs.features }}"/' index.html

      - name: Disable wasm-opt if not optimizing
        if: ${{ !inputs.optimize }}
        run: |
          sed -i 's/data-wasm-opt="[^"]*"/data-wasm-opt="0"/' index.html

      - name: Build WASM
        run: trunk build --release --public-url "${{ inputs.public_url }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: dist/
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: error
